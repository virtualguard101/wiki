---
date: 2025-10-28 16:42:40
title: 同步与互斥
permalink: 
publish: true
---

# 同步与互斥

## 部分概念

### 操作系统中的资源类型

#### 可重用性资源

顾名思义，就是可供用户重复多次使用的资源。

- 一次只能分配给一个进程，不允许多个进程共享

- 进程在使用该资源时，需要先申请并获得该资源，使用完毕后释放该资源

- 单元数目相对固定，进程在运行期间既不能创建也不能删除

#### 可消耗性资源

临时性资源，由进程动态创建和消耗（进程通信间的消息、信号量等）。

- 单元数目不固定，可以按需要随时创建，使用完毕后自动释放

#### 可抢占资源

某进程在获得这类资源后，该进程可以再被其他进程或系统抢占（如处理机、主存等）。

#### 不可抢占资源

当系统把这类资源分配给某进程后，就不能再强行收回，只能在进程用完后自行释放（如磁带、打印机等）。

#### ⭐临界资源

**临界资源（*Critical Resource*）**是指在操作系统中，多个进程需要通过**互斥**访问方法访问的、**不可抢占**的资源。

### 访问临界资源

每个进程中访问临界资源的那段代码称为**临界区**。临界资源的访问大致可分为四个步骤:

1. 进入区: 检查是否可以进入临界区

2. 临界区: 访问临界资源的代码，也成为**临界段**

3. 退出区: 释放临界资源，将正在访问临界区的标志清除

4. 剩余区: 代码的其余部分

```cpp
while (true) {
  // 进入区
  while (flag[i] != 0) {
    // 等待
  }
  flag[i] = 1;

  critical section;  // 临界区

  flag[i] = 0;

  exit section;      // 退出区

  remainder section; // 剩余区
}
```

### 同步

**同步（*Synchronization*）**也称为**直接约束关系**，是指为完成某种任务而建立的两个或多个进程，因为需要协调它们的工作次序并等待它们相互通信、等待消息等所产生的制约关系。

同步的本质是**资源访问的排队机制**，源于进程之间的相互合作。

- 核心要素

    - 共享资源：收银机（临界资源）

    - 访问控制：排队规则（同步原语）

    - 互斥访问：同一时刻只有一个人能用收银机

    - 顺序保证：先到先得（happens-before）

!!! example
    - 没有同步：
        ```
        10:00 - 你：我要一杯珍珠奶茶
        10:00 - 小明：我要一杯柠檬茶  
        10:00 - 小红：我要一杯抹茶拿铁
        店员：？？？你们同时说话我听不清！
        ```
        结果：订单混乱，可能做错或漏做（不可重现）

    - 有同步：
        ```
        10:00 - 你：我要一杯珍珠奶茶（获得"收银机锁"）
        10:01 - 店员：好的，15元（你释放锁）
        10:01 - 小明：我要一杯柠檬茶（获得"收银机锁"）
        10:02 - 店员：好的，12元（小明释放锁）
        10:02 - 小红：我要一杯抹茶拿铁（获得"收银机锁"）
        ```
        结果：每个人都能清楚下单，不会混乱

    ```cpp
    // 收银机 = 共享变量
    int cash_register = 0;  // 收银机状态
    std::mutex line_mutex;  // 排队规则

    void buy_drink(string customer, string drink) {
        std::lock_guard<std::mutex> lock(line_mutex);  // 排队等待
        
        // 临界区：使用收银机
        cout << customer << "In Processing" << drink << endl;
        cash_register++;  // 更新收银机状态
        
        // 自动释放锁，下一个人可以排队
    }
    ```

